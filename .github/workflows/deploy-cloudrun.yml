# =============================================================================
# Salon Flow API - GitHub Actions CI/CD for Cloud Run
# =============================================================================
# Required GitHub Secrets:
#   - GCP_SA_KEY: GCP Service Account JSON key
#   - OPENROUTER_API_KEY: OpenRouter API key
#   - UPSTASH_REDIS_URL: Upstash Redis connection URL
#   - JWT_SECRET: JWT signing secret
# =============================================================================

name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - 'services/api/**'
      - '.github/workflows/deploy-cloudrun.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'services/api/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  PROJECT_ID: salon-saas-487508
  REGION: asia-south1
  SERVICE_NAME: salon-flow-api
  ARTIFACT_REPO: salon-flow-images

jobs:
  # ===========================================================================
  # Test Job
  # ===========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd services/api
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Run tests
        run: |
          cd services/api
          pytest tests/ -v --cov=app --cov-report=xml
        env:
          ENVIRONMENT: test
          FIREBASE_PROJECT_ID: salon-saas-487508

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./services/api/coverage.xml
          fail_ci_if_error: false

  # ===========================================================================
  # Build Job
  # ===========================================================================
  build:
    name: Build & Push Image
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Extract metadata
        id: meta
        run: |
          echo "tags=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE_NAME }}:latest \
            -f services/api/Dockerfile.cloudrun \
            services/api

      - name: Push Docker image
        run: |
          docker push --all-tags ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE_NAME }}

  # ===========================================================================
  # Deploy Job
  # ===========================================================================
  deploy:
    name: Deploy to Cloud Run
    needs: build
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Create/Update Secrets
        run: |
          # Create secrets if they don't exist
          echo "${{ secrets.OPENROUTER_API_KEY }}" | gcloud secrets create openrouter-api-key --data-file=- --project=${{ env.PROJECT_ID }} 2>/dev/null || \
          echo "${{ secrets.OPENROUTER_API_KEY }}" | gcloud secrets versions add openrouter-api-key --data-file=- --project=${{ env.PROJECT_ID }}
          
          echo "${{ secrets.UPSTASH_REDIS_URL }}" | gcloud secrets create upstash-redis-url --data-file=- --project=${{ env.PROJECT_ID }} 2>/dev/null || \
          echo "${{ secrets.UPSTASH_REDIS_URL }}" | gcloud secrets versions add upstash-redis-url --data-file=- --project=${{ env.PROJECT_ID }}
          
          echo "${{ secrets.JWT_SECRET }}" | gcloud secrets create jwt-secret --data-file=- --project=${{ env.PROJECT_ID }} 2>/dev/null || \
          echo "${{ secrets.JWT_SECRET }}" | gcloud secrets versions add jwt-secret --data-file=- --project=${{ env.PROJECT_ID }}

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --timeout=300 \
            --set-env-vars="ENVIRONMENT=production,FIREBASE_PROJECT_ID=${{ env.PROJECT_ID }}" \
            --set-secrets="GCP_JSON_KEY=gcp-json-key:latest,OPENROUTER_API_KEY=openrouter-api-key:latest,UPSTASH_REDIS_URL=upstash-redis-url:latest,JWT_SECRET=jwt-secret:latest" \
            --no-allow-unauthenticated \
            --ingress=all \
            --project=${{ env.PROJECT_ID }}

      - name: Get Service URL
        id: service_url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format='value(status.url)' --project=${{ env.PROJECT_ID }})
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT

      - name: Health Check
        run: |
          SERVICE_URL=${{ steps.service_url.outputs.url }}
          TOKEN=$(gcloud auth print-identity-token)
          
          echo "Service URL: $SERVICE_URL"
          
          for i in {1..30}; do
            if curl -s -f "$SERVICE_URL/health" -H "Authorization: Bearer $TOKEN"; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i: Service not ready, waiting..."
            sleep 5
          done
          
          echo "Health check failed after 30 attempts"
          exit 1

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ Deployed to Cloud Run!\n\n**Service URL:** ${{ steps.service_url.outputs.url }}'
            })
